---
/**
 * Giscus 댓글 시스템 컴포넌트
 * GitHub Discussions 기반 댓글 시스템
 * 
 * @see https://giscus.app/ko
 * 
 * 설정 방법:
 * 1. GitHub 저장소에서 Discussions 활성화
 * 2. https://giscus.app/ko 에서 설정값 얻기
 * 3. 이 컴포넌트에 props로 전달
 */

 interface Props {
  repo: string;           // 예: "username/repo-name"
  repoId: string;         // 예: "R_kgDOGb..."
  category: string;       // 예: "General" 또는 "Announcements"
  categoryId: string;     // 예: "DIC_kwDOGb..."
  mapping?: string;       // 기본: "pathname"
  theme?: string;         // 기본: "preferred_color_scheme"
  lang?: string;          // 기본: "ko"
}

const { 
  repo, 
  repoId, 
  category, 
  categoryId,
  mapping = "pathname",
  theme = "preferred_color_scheme",
  lang = "ko"
} = Astro.props;
---

<div class="giscus-wrapper mt-16 pt-16 border-t border-border">
  <div class="max-w-4xl mx-auto">
    <div class="flex items-center gap-4 mb-8">
      <div class="w-12 h-px bg-foreground"></div>
      <h2 class="text-2xl tracking-tight">댓글</h2>
    </div>
    
    <div class="giscus"></div>
  </div>
</div>

<!-- Giscus 스크립트 -->
<script
  is:inline
  src="https://giscus.app/client.js"
  data-repo={repo}
  data-repo-id={repoId}
  data-category={category}
  data-category-id={categoryId}
  data-mapping={mapping}
  data-strict="0"
  data-reactions-enabled="1"
  data-emit-metadata="0"
  data-input-position="top"
  data-theme={theme}
  data-lang={lang}
  data-loading="lazy"
  crossorigin="anonymous"
  async
></script>

<!-- 다크모드 동기화 -->
<script is:inline>
  // Giscus 테마를 다크모드와 동기화
  const updateGiscusTheme = () => {
    const theme = document.documentElement.classList.contains('dark') 
      ? 'dark' 
      : 'light';
    
    const iframe = document.querySelector('iframe.giscus-frame');
    if (!iframe) return;
    
    iframe.contentWindow?.postMessage(
      { giscus: { setConfig: { theme } } },
      'https://giscus.app'
    );
  };

  // 초기 로드 시
  window.addEventListener('load', () => {
    setTimeout(updateGiscusTheme, 1000);
  });

  // 테마 변경 감지 (MutationObserver)
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        updateGiscusTheme();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
</script>

<style>
  .giscus-wrapper {
    @apply w-full;
  }

  /* Giscus iframe 스타일 커스터마이징 */
  :global(.giscus-frame) {
    @apply w-full;
  }

  /* 로딩 상태 */
  .giscus:empty::before {
    content: "댓글을 불러오는 중...";
    @apply text-sm text-muted-foreground flex items-center justify-center py-8;
  }
</style>
